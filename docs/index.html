<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>–ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      font-family: Arial, sans-serif;
      background-color: #30013C;
      color: white;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
    }
    #logo { max-width: 60%; height: auto; margin: 20px auto 10px; }
    #wheel-container {
      position: relative;
      width: 90vw;
      max-width: 400px;
      aspect-ratio: 1 / 1;
    }
    #wheel {
      width: 100%; height: 100%; border-radius: 50%;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .pointer {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 40px solid white;
      filter: drop-shadow(0 0 10px black);
      z-index: 10;
    }
    #spin-btn {
      margin-top: 20px;
      padding: 12px 30px;
      background: linear-gradient(to bottom, #FFD700, #FFA500);
      border: none;
      border-radius: 25px;
      color: #30013C;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: all 0.3s;
    }
    #spin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 20px rgba(0,0,0,0.4);
    }
    #spin-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #win-result, #cooldown-timer {
      margin-top: 10px;
      font-size: 20px;
      text-align: center;
      padding: 0 10px;
      min-height: 24px;
    }
  </style>
</head>
<body>
  <img src="logo.png" id="logo" alt="–õ–æ–≥–æ—Ç–∏–ø" />
  <div id="wheel-container">
    <div class="pointer"></div>
    <canvas id="wheel"></canvas>
  </div>
  <button id="spin-btn">–ö—Ä—É—Ç–∏—Ç—å</button>
  <div id="win-result"></div>
  <div id="cooldown-timer"></div>

  <script>
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const spinBtn = document.getElementById("spin-btn");
    const winResult = document.getElementById("win-result");
    const cooldownTimer = document.getElementById("cooldown-timer");

    const prizes = [
      "100 PTS", "180 PTS", "15 PTS", "10 PTS",
      "20 PTS", "30 PTS", "35 PTS", "7 PTS",
      "100 PTS", "180 PTS", "15 PTS", "10 PTS",
      "20 PTS", "30 PTS", "35 PTS", "7 PTS"
    ];
    const colors = ["#C6001E", "#FDFE05"];
    const numSectors = prizes.length;
    const anglePerSector = (2 * Math.PI) / numSectors;

    let rotation = 0;
    let isSpinning = false;
    let spinVelocity = 0;
    const spinDeceleration = 0.99;
    const cooldownTime = 60 * 1000;

    function getLastSpin() {
      return localStorage.getItem("lastSpinTime");
    }

    function setLastSpin(time) {
      localStorage.setItem("lastSpinTime", time);
    }

    function canSpin() {
      const lastSpin = getLastSpin();
      if (!lastSpin) return true;
      return Date.now() - lastSpin >= cooldownTime;
    }

    function updateCooldown() {
      const lastSpin = getLastSpin();
      if (!lastSpin) {
        spinBtn.disabled = false;
        cooldownTimer.textContent = "";
        return;
      }

      const now = Date.now();
      const diff = cooldownTime - (now - lastSpin);

      if (diff <= 0) {
        spinBtn.disabled = false;
        cooldownTimer.textContent = "";
      } else {
        spinBtn.disabled = true;
        const seconds = Math.floor(diff / 1000) % 60;
        const minutes = Math.floor(diff / 60000) % 60;
        const hours = Math.floor(diff / 3600000) % 24;
        const days = Math.floor(diff / 86400000);
        cooldownTimer.textContent = `–°–ª–µ–¥—É—é—â–∏–π —Å–ø–∏–Ω —á–µ—Ä–µ–∑: ${days}–¥ ${hours}—á ${minutes}–º ${seconds}—Å`;
      }
    }

    function resizeCanvas() {
      const container = document.getElementById("wheel-container");
      const size = container.offsetWidth;
      canvas.width = size;
      canvas.height = size;
      drawWheel();
    }

    function drawWheel() {
      const size = canvas.width;
      const center = size / 2;
      const radius = center - 10;

      ctx.clearRect(0, 0, size, size);

      for (let i = 0; i < numSectors; i++) {
        const angle = rotation + i * anglePerSector;
        ctx.beginPath();
        ctx.moveTo(center, center);
        ctx.arc(center, center, radius, angle, angle + anglePerSector);
        ctx.fillStyle = colors[i % colors.length];
        ctx.fill();
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.save();
        ctx.translate(center, center);
        ctx.rotate(angle + anglePerSector / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#000";
        ctx.font = "bold 12px Arial";
        ctx.fillText(prizes[i], radius - 15, 5);
        ctx.restore();
      }

      ctx.beginPath();
      ctx.arc(center, center, 20, 0, 2 * Math.PI);
      ctx.fillStyle = "#fff";
      ctx.fill();
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    function spinWheel() {
      if (isSpinning || !canSpin()) return;
      isSpinning = true;
      spinBtn.disabled = true;
      spinVelocity = 0.1 + Math.random() * 0.1;
      animateSpin();
    }

    function animateSpin() {
      rotation += spinVelocity;
      spinVelocity *= spinDeceleration;
      drawWheel();
      if (spinVelocity < 0.001) {
        finishSpin();
        return;
      }
      requestAnimationFrame(animateSpin);
    }

    function finishSpin() {
      isSpinning = false;
      setLastSpin(Date.now());

      rotation = rotation % (2 * Math.PI);
      const pointerAngle = (2 * Math.PI - rotation + Math.PI / 2) % (2 * Math.PI);
      const selectedIndex = Math.floor(pointerAngle / anglePerSector) % numSectors;
      
      const prize = prizes[selectedIndex];
      console.log("–í—ã–∏–≥—Ä–∞–Ω –ø—Ä–∏–∑:", prize);

      winResult.textContent = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: ${prize}`;
      winResult.style.color = colors[selectedIndex % colors.length];

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞
      setTimeout(() => {
        if (window.Telegram?.WebApp?.sendData) {
          const data = {
            action: "save_win",
            prize: prize
          };
          console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞:", data);
          Telegram.WebApp.sendData(JSON.stringify(data));
          
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(() => {
            Telegram.WebApp.close();
          }, 3000);
        } else {
          console.log("üíª –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º - –ø—Ä–∏–∑:", prize);
        }
      }, 2000);
    }

    spinBtn.addEventListener("click", spinWheel);
    window.addEventListener("resize", () => {
      resizeCanvas();
      updateCooldown();
    });

    resizeCanvas();
    updateCooldown();
    setInterval(updateCooldown, 1000);
  </script>
</body>
</html>
